name: Tag and Release

permissions:
  id-token: write
  contents: write
  actions: read
  packages: write
  statuses: write

on:
  push:
    branches: [main]
    paths-ignore:
      - '.github/**'
      - '*.md'
      - 'docs/**'
      - 'mkdocs.yml'

jobs:
  tag-and-release:
    name: Tag and Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          # IMPORTANT: To trigger other workflows, you need to use a Personal Access Token
          # Create a PAT with 'contents:write' and 'actions:write' permissions
          # Add it as a secret named GH_PAT in your repository settings
          # If GH_PAT is not available, it will fall back to GITHUB_TOKEN
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Fetch existing tags
        run: git fetch --force --tags

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          release_branches: main
          tag_prefix: v
          github_token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          create_annotated_tag: true
          default_bump: patch

      - name: Set up Go
        if: steps.tag_version.outputs.new_tag != ''
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.4'

      - name: Set up QEMU
        if: steps.tag_version.outputs.new_tag != ''
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.tag_version.outputs.new_tag != ''
        uses: docker/setup-buildx-action@v3

      - name: Run GoReleaser
        if: steps.tag_version.outputs.new_tag != ''
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser-cross
          version: '~> v1.25'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ steps.tag_version.outputs.new_tag }}

      - name: Upload artifacts
        if: steps.tag_version.outputs.new_tag != ''
        uses: actions/upload-artifact@v5
        with:
          name: release-artifacts
          path: dist/*
          retention-days: 30

      - name: Create GitHub Release Summary
        if: steps.tag_version.outputs.new_tag != ''
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.tag_version.outputs.new_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Tag:** ${{ steps.tag_version.outputs.previous_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changelog" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.tag_version.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY