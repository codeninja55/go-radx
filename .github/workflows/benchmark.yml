name: Benchmark

on:
  pull_request:
    paths:
      - 'dicom/**/*.go'
      - 'dimse/**/*.go'
      - 'benchmarks/**'
      - '.github/workflows/benchmark.yml'
  push:
    branches:
      - main
    paths:
      - 'dicom/**/*.go'
      - 'dimse/**/*.go'
      - 'benchmarks/**'
  workflow_dispatch:
    inputs:
      benchtime:
        description: 'Benchmark duration (e.g., 1s, 5s, 10s)'
        required: false
        default: '1s'
      count:
        description: 'Number of benchmark runs'
        required: false
        default: '5'

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Run benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Run benchmarks on current branch
        run: |
          BENCHTIME="${{ github.event.inputs.benchtime || '1s' }}"
          COUNT="${{ github.event.inputs.count || '5' }}"

          go test -bench=. -benchmem -benchtime="$BENCHTIME" -count="$COUNT" \
            ./benchmarks | tee current.txt

      - name: Upload current benchmark results
        uses: actions/upload-artifact@v5
        with:
          name: benchmark-current
          path: current.txt
          retention-days: 30

      - name: Checkout base branch for comparison
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

      - name: Run benchmarks on base branch
        if: github.event_name == 'pull_request'
        run: |
          BENCHTIME="${{ github.event.inputs.benchtime || '1s' }}"
          COUNT="${{ github.event.inputs.count || '5' }}"

          go test -bench=. -benchmem -benchtime="$BENCHTIME" -count="$COUNT" \
            ./benchmarks | tee base.txt

      - name: Upload base benchmark results
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v5
        with:
          name: benchmark-base
          path: base.txt
          retention-days: 30

      - name: Compare benchmark results
        if: github.event_name == 'pull_request'
        id: compare
        run: |
          echo "## Benchmark Comparison" > comparison.md
          echo "" >> comparison.md
          echo "Comparing current PR against base branch \`${{ github.base_ref }}\`" >> comparison.md
          echo "" >> comparison.md
          echo '```' >> comparison.md
          benchstat base.txt current.txt | tee -a comparison.md
          echo '```' >> comparison.md

          # Check for significant regressions (>20% slower or >20% more memory)
          if benchstat -delta-test=ttest base.txt current.txt | grep -E '\+[2-9][0-9]\.[0-9]+%|^\+[1-9][0-9][0-9]\.[0-9]+%'; then
            echo "REGRESSION_DETECTED=true" >> $GITHUB_OUTPUT
            echo "" >> comparison.md
            echo "⚠️ **Performance regression detected!**" >> comparison.md
            echo "" >> comparison.md
            echo "Some benchmarks show >20% performance degradation." >> comparison.md
          else
            echo "REGRESSION_DETECTED=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with benchmark results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('comparison.md', 'utf8');

            // Find existing benchmark comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Benchmark Comparison')
            );

            const commentBody = comparison;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Check for regression threshold
        if: github.event_name == 'pull_request' && steps.compare.outputs.REGRESSION_DETECTED == 'true'
        run: |
          echo "::warning::Performance regression detected (>20% slower or more memory usage)"
          echo "::warning::Review the benchmark comparison above"
          # Note: We don't fail the build, just warn
          # Uncomment the line below to make regressions fail the build:
          # exit 1

      - name: Store benchmark baseline (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          mkdir -p benchmark-history
          cp current.txt "benchmark-history/$(date +%Y%m%d-%H%M%S).txt"

      - name: Upload benchmark history
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v5
        with:
          name: benchmark-history-${{ github.sha }}
          path: benchmark-history/
          retention-days: 90
