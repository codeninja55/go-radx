# Implementation Tasks

## 1. Preparation and Analysis
- [ ] 1.1 Create comprehensive test suite from existing testdata/fhir/r4/examples/*.json
- [ ] 1.2 Create baseline benchmarks for marshal/unmarshal performance
- [ ] 1.3 Document all current `any` type usage patterns (620+ locations)
- [ ] 1.4 Create migration guide template

## 2. Update Base Types
- [ ] 2.1 Change `fhir/resource.go:42` - `Contained []interface{}` → `Contained []json.RawMessage`
- [ ] 2.2 Add helper method `DomainResource.UnmarshalContainedResource(idx int) (any, error)`
- [ ] 2.3 Add helper method `DomainResource.AddContainedResource(resource interface{}) error`
- [ ] 2.4 Add helper method `DomainResource.GetContainedResource(id string) (json.RawMessage, error)`
- [ ] 2.5 Update `fhir/INHERITANCE.md` documentation with new patterns
- [ ] 2.6 Write tests for base type changes

## 3. Fix Bundle Consistency
- [ ] 3.1 Update `fhir/r5/resources/bundle.go:95` - `Resource *any` → `Resource json.RawMessage`
- [ ] 3.2 Update `fhir/r5/resources/bundle.go:79` - `Outcome *any` → `Outcome json.RawMessage`
- [ ] 3.3 Update `fhir/r5/resources/bundle.go:129` - `Issues *any` → `Issues json.RawMessage`
- [ ] 3.4 Add helper method `BundleEntry.UnmarshalResource(v interface{}) error`
- [ ] 3.5 Add helper method `BundleEntryResponse.UnmarshalOutcome(v interface{}) error`
- [ ] 3.6 Ensure R5 Bundle matches base `fhir/bundle.go` patterns
- [ ] 3.7 Update bundle helper tests in `fhir/r5/resources/bundle_helpers_test.go`

## 4. Download and Track R5 Schemas
- [ ] 4.1 Create `fhir/scripts/download_r5_schemas.sh` script
- [ ] 4.2 Download R5 profiles-resources.json from HL7 official site
- [ ] 4.3 Download R5 profiles-types.json from HL7 official site
- [x] 4.4 Store schemas in `fhir_schemas/r5/` directory
- [x] 4.5 Add README documenting schema version, download date, and source URL
- [x] 4.6 Track schemas in version control for reproducible builds
- [ ] 4.7 Update `.gitignore` to include schemas (remove any existing ignore rules)

## 5. Update Code Generator - json.RawMessage Support
- [x] 5.1 Update `parser/typemapper.go:44` - Change `"Resource": "any"` to `"Resource": "json.RawMessage"`
- [x] 5.2 Add import detection for `encoding/json` when json.RawMessage is used
- [x] 5.3 Update `codegen/generator.go` to emit correct imports for json.RawMessage (added needsJSONImport and needsFHIRImport functions)
- [ ] 5.4 Fix `parser/typemapper.go:122` - handle non-choice polymorphic types (investigate edge cases)
- [ ] 5.5 Add unit tests for json.RawMessage type mapping
- [x] 5.6 Verify choice type expansion still works (already implemented at lines 129-161)

## 6. Add Generated Code Metadata
- [x] 6.1 Update `codegen/generator.go:250` template to add header comment
- [x] 6.2 Add "Code generated by fhirgen. DO NOT EDIT." warning
- [ ] 6.3 Include generation timestamp in header
- [x] 6.4 Include FHIR version (R5) in header
- [x] 6.5 Include source StructureDefinition URL in header
- [ ] 6.6 Add generator version/commit hash for traceability
- [x] 6.7 Test that generated files include proper headers

## 7. Update Generation Scripts for R5
- [ ] 7.1 Review existing `scripts/generate.sh` (currently R4 only)
- [ ] 7.2 Option A: Make generate.sh version-aware with parameters
- [ ] 7.3 Option B: Create separate `scripts/generate_r5.sh`
- [ ] 7.4 Document generation process in `fhir/scripts/gen/GENERATOR.md`
- [ ] 7.5 Add Makefile targets for R5 generation: `make generate-r5-resources`, `make generate-r5-types`

## 8. Regenerate R5 Resources with Enhanced Generator
- [x] 8.1 Build updated generator: `cd fhir/scripts/gen && go build -o bin/fhirgen .`
- [x] 8.2 Generate R5 resources: `./bin/fhirgen -version r5 -input fhir_schemas/r5/profiles-resources.json -output fhir/r5/resources -verbose`
- [x] 8.3 Generate R5 complex types: `./bin/fhirgen -version r5 -input fhir_schemas/r5/profiles-types.json -output fhir/r5/types -verbose`
- [x] 8.4 Verify all generated files have proper headers
- [x] 8.5 Verify generated code compiles without errors
- [ ] 8.6 Run `go fmt` on all generated files
- [ ] 8.7 Run `golangci-lint` on generated code and fix any issues
- [x] 8.8 Review sample generated files for correctness

## 9. Update Validation Framework
- [ ] 9.1 Update `fhir/validation/validator.go` for choice type validation
- [ ] 9.2 Add validation rule: only one field per choice group can be set
- [ ] 9.3 Add validation for choice field struct tags
- [ ] 9.4 Update existing validation tests
- [ ] 9.5 Add new tests for choice type validation

## 10. Improve Generator Testing
- [ ] 10.1 Add unit tests for `parser/typemapper.go`
- [ ] 10.2 Add unit tests for choice type expansion in `parser/typemapper_test.go`
- [ ] 10.3 Add unit tests for json.RawMessage handling
- [ ] 10.4 Add integration tests for `codegen/generator.go`
- [ ] 10.5 Test generated code header comments and metadata
- [ ] 10.6 Add golden file tests for common resources (Patient, Observation, Bundle)
- [ ] 10.7 Test roundtrip JSON → struct → JSON for generated types
- [ ] 10.8 Add benchmark tests for generator performance

## 11. Update Documentation
- [ ] 11.1 Update `fhir/CHOICE_TYPES.md` with new patterns
- [ ] 11.2 Update `fhir/BUNDLE.md` with UnmarshalResource examples
- [ ] 11.3 Create migration guide in `docs/FHIR_V2_MIGRATION.md`
- [ ] 11.4 Add examples showing before/after code
- [ ] 11.5 Document breaking changes and migration steps
- [ ] 11.6 Update README.md with v2 information

## 12. Testing - Unit Tests
- [ ] 12.1 Test Contained resource operations (add, get, unmarshal)
- [ ] 12.2 Test Bundle entry operations (add, unmarshal)
- [ ] 12.3 Test choice type serialization (Patient.deceased[x])
- [ ] 12.4 Test choice type validation (mutual exclusion)
- [ ] 12.5 Test polymorphic value types (UsageContext.value[x])
- [ ] 12.6 Test all categories of `any` type replacements
- [ ] 12.7 Ensure all existing tests still pass

## 13. Testing - Integration Tests
- [ ] 13.1 Test roundtrip: JSON → struct → JSON for all resource types
- [ ] 13.2 Test with real-world examples from testdata/fhir/r4/examples/
- [ ] 13.3 Test with real-world examples from testdata/fhir/examples/
- [ ] 13.4 Test Bundle operations end-to-end
- [ ] 13.5 Test choice type scenarios from FHIR spec examples
- [ ] 13.6 Test error cases and validation failures

## 14. Testing - Performance
- [ ] 14.1 Benchmark marshal/unmarshal for all resource types
- [ ] 14.2 Compare performance vs baseline (should be same or better)
- [ ] 14.3 Benchmark choice type access patterns
- [ ] 14.4 Benchmark Bundle entry operations
- [ ] 14.5 Profile memory usage

## 15. Examples and User Guides
- [ ] 15.1 Update `fhir/examples/create_patient.go` with choice type usage
- [ ] 15.2 Update `fhir/examples/read_json.go` with UnmarshalResource
- [ ] 15.3 Create example: Working with contained resources
- [ ] 15.4 Create example: Bundle entry navigation
- [ ] 15.5 Create example: Choice type validation
- [ ] 15.6 Update `fhir/examples/search_results_processing.go`

## 16. Compatibility and Migration Tools
- [ ] 16.1 Create v1 → v2 migration guide
- [ ] 16.2 Document common migration patterns
- [ ] 16.3 (Optional) Create AST-based migration tool
- [ ] 16.4 Test backward compatibility for JSON parsing
- [ ] 16.5 Ensure v1 JSON can be unmarshaled by v2 structs

## 17. Code Review and Quality
- [ ] 17.1 Run `make fmt` on all changes
- [ ] 17.2 Run `make lint` and fix all issues
- [ ] 17.3 Run `make test` and ensure 100% pass rate
- [ ] 17.4 Run `make integration-test` and ensure all pass
- [ ] 17.5 Review code coverage - ensure no regression
- [ ] 17.6 Peer review of generated code patterns

## 18. Documentation Review
- [ ] 18.1 Review all updated documentation for accuracy
- [ ] 18.2 Test all code examples in documentation
- [ ] 18.3 Ensure migration guide is complete
- [ ] 18.4 Update CHANGELOG.md with breaking changes
- [ ] 18.5 Create release notes for v2

## 19. Final Validation
- [ ] 19.1 Full test suite pass
- [ ] 19.2 All linters pass
- [ ] 19.3 Performance benchmarks within acceptable range
- [ ] 19.4 Documentation complete and accurate
- [ ] 19.5 Examples tested and working
- [ ] 19.6 Migration guide reviewed and validated